# HRMS 数据库架构分析

## 数据库系统概览
### 多数据库架构
| 数据库类型 | 实例信息 | 主要用途 | 存储内容 |
|-----------|----------|----------|----------|
| SQLite | 开发环境: ./data/hrms_C001.db, ./data/hrms_C002.db | 开发测试 | 业务数据、用户数据 |
| MySQL | 生产环境: root@127.0.0.1:3306 | 生产业务库 | 业务数据、用户数据 |

### 多租户架构
- **数据库命名规则**: `hrms_{branch_id}` (如: hrms_C001, hrms_C002)
- **租户隔离**: 通过Cookie中的branch_id实现数据库级别的数据隔离
- **连接管理**: 使用GORM框架管理多个数据库连接

## PostgreSQL 业务数据库分析

### 数据表分类
#### 核心业务表
- **staff** - 员工基本信息管理
- **department** - 部门管理
- **salary** - 薪资管理
- **attendance_record** - 考勤记录
- **recruitment** - 招聘管理
- **candidate** - 候选人管理

#### 权限管理表
- **authority** - 用户权限基础信息
- **authority_detail** - 细粒度权限配置

#### 系统管理表
- **branch_company** - 分公司信息
- **rank** - 职级管理
- **notification** - 通知公告
- **example** - 考核评估
- **example_score** - 考核成绩

#### 财务管理表
- **salary_record** - 薪资发放记录

### 详细表结构分析

#### 1. staff - 员工基本信息表
**业务含义**: 存储员工的基本信息、联系方式、职位等核心数据

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| staff_id | varchar(20) | 主键,非空 | NULL | 员工工号 |
| staff_name | varchar(50) | 非空 | NULL | 员工姓名 |
| leader_staff_id | varchar(20) | 外键(staff.staff_id) | NULL | 直属领导工号 |
| leader_name | varchar(50) | | NULL | 直属领导姓名 |
| birthday | date | | NULL | 出生日期 |
| identity_num | varchar(18) | | NULL | 身份证号 |
| sex | varchar(10) | | NULL | 性别 |
| nation | varchar(20) | | NULL | 民族 |
| school | varchar(100) | | NULL | 毕业院校 |
| major | varchar(100) | | NULL | 专业 |
| edu_level | varchar(20) | | NULL | 教育水平 |
| base_salary | decimal(10,2) | | NULL | 基本工资 |
| card_num | varchar(20) | | NULL | 银行卡号 |
| rank_id | int | 外键(rank.rank_id) | NULL | 职级ID |
| dep_id | int | 外键(department.dep_id) | NULL | 部门ID |
| email | varchar(100) | | NULL | 邮箱 |
| phone | varchar(20) | | NULL | 电话 |
| entry_date | date | | NULL | 入职日期 |

**索引设计**:
- 主键索引: `PRIMARY KEY (staff_id)`
- 外键索引: `fk_staff_leader` (leader_staff_id)
- 外键索引: `fk_staff_rank` (rank_id)
- 外键索引: `fk_staff_department` (dep_id)

**关联关系**:
- 自关联: staff → staff (领导关系)
- 多对一: staff → rank (职级关系)
- 多对一: staff → department (部门关系)
- 一对多: staff → authority (权限关系)
- 一对多: staff → attendance_record (考勤记录)
- 一对多: staff → salary (薪资信息)
- 一对多: staff → candidate (候选人信息)

#### 2. department - 部门管理表
**业务含义**: 管理公司组织架构中的部门信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| dep_id | int | 主键,自增 | auto_increment | 部门ID |
| dep_name | varchar(100) | 非空 | NULL | 部门名称 |
| dep_describe | varchar(500) | | NULL | 部门描述 |

**索引设计**:
- 主键索引: `PRIMARY KEY (dep_id)`

**关联关系**:
- 一对多: department → staff (部门员工)

#### 3. authority - 用户权限表
**业务含义**: 存储用户的基本权限信息和认证数据

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| authority_id | int | 主键,自增 | auto_increment | 权限ID |
| staff_id | varchar(20) | 外键(staff.staff_id),唯一 | NULL | 员工工号 |
| user_password | varchar(100) | 非空 | NULL | 用户密码 |
| user_type | varchar(20) | 非空 | NULL | 用户类型(supersys/sys/normal) |

**索引设计**:
- 主键索引: `PRIMARY KEY (authority_id)`
- 唯一索引: `UNIQUE KEY (staff_id)`
- 外键索引: `fk_authority_staff` (staff_id)

**关联关系**:
- 一对一: authority → staff (用户权限)
- 一对多: authority → authority_detail (权限详情)

#### 4. authority_detail - 权限详情表
**业务含义**: 存储细粒度的权限配置信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | int | 主键,自增 | auto_increment | 权限详情ID |
| user_type | varchar(20) | 非空 | NULL | 用户类型 |
| model | varchar(100) | 非空 | NULL | 功能模块标识 |
| authority_content | varchar(500) | 非空 | NULL | 权限内容描述 |
| name | varchar(100) | 非空 | NULL | 功能模块名称 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`

**关联关系**:
- 多对一: authority_detail → authority (权限基础信息)

#### 5. salary - 薪资配置表
**业务含义**: 存储员工的薪资配置信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| salary_id | int | 主键,自增 | auto_increment | 薪资ID |
| staff_id | varchar(20) | 外键(staff.staff_id),唯一 | NULL | 员工工号 |
| staff_name | varchar(50) | 非空 | NULL | 员工姓名 |
| base | decimal(10,2) | | NULL | 基本工资 |
| subsidy | decimal(10,2) | | NULL | 津贴 |
| bonus | decimal(10,2) | | NULL | 奖金 |
| commission | decimal(10,2) | | NULL | 提成 |
| fund | decimal(10,2) | | NULL | 公积金 |
| other | decimal(10,2) | | NULL | 其他 |

**索引设计**:
- 主键索引: `PRIMARY KEY (salary_id)`
- 唯一索引: `UNIQUE KEY (staff_id)`
- 外键索引: `fk_salary_staff` (staff_id)

**关联关系**:
- 一对一: salary → staff (员工薪资配置)
- 一对多: salary → salary_record (薪资发放记录)

#### 6. salary_record - 薪资发放记录表
**业务含义**: 记录每次薪资发放的详细信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| record_id | int | 主键,自增 | auto_increment | 记录ID |
| staff_id | varchar(20) | 外键(staff.staff_id) | NULL | 员工工号 |
| staff_name | varchar(50) | 非空 | NULL | 员工姓名 |
| base | decimal(10,2) | | NULL | 基本工资 |
| subsidy | decimal(10,2) | | NULL | 津贴 |
| bonus | decimal(10,2) | | NULL | 奖金 |
| commission | decimal(10,2) | | NULL | 提成 |
| fund | decimal(10,2) | | NULL | 公积金 |
| other | decimal(10,2) | | NULL | 其他 |
| endowment_insurance | decimal(10,2) | | NULL | 养老保险 |
| medical_insurance | decimal(10,2) | | NULL | 医疗保险 |
| unemployment_insurance | decimal(10,2) | | NULL | 失业保险 |
| housing_fund | decimal(10,2) | | NULL | 住房公积金 |
| tax | decimal(10,2) | | NULL | 个人所得税 |
| total | decimal(10,2) | | NULL | 实发工资 |
| date | varchar(20) | | NULL | 发放日期 |
| status | varchar(20) | | NULL | 发放状态 |

**索引设计**:
- 主键索引: `PRIMARY KEY (record_id)`
- 外键索引: `fk_salary_record_staff` (staff_id)

**关联关系**:
- 多对一: salary_record → salary (薪资配置)

#### 7. attendance_record - 考勤记录表
**业务含义**: 记录员工的考勤信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| attendance_id | int | 主键,自增 | auto_increment | 考勤ID |
| staff_id | varchar(20) | 外键(staff.staff_id) | NULL | 员工工号 |
| staff_name | varchar(50) | 非空 | NULL | 员工姓名 |
| date | varchar(20) | | NULL | 考勤日期 |
| work_days | decimal(5,2) | | NULL | 工作天数 |
| leave_days | decimal(5,2) | | NULL | 请假天数 |
| overtime_days | decimal(5,2) | | NULL | 加班天数 |
| approve | varchar(20) | | NULL | 审批状态 |

**索引设计**:
- 主键索引: `PRIMARY KEY (attendance_id)`
- 外键索引: `fk_attendance_staff` (staff_id)

**关联关系**:
- 多对一: attendance_record → staff (员工考勤)

#### 8. recruitment - 招聘职位表
**业务含义**: 管理招聘职位信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| recruitment_id | int | 主键,自增 | auto_increment | 招聘ID |
| job_name | varchar(100) | 非空 | NULL | 职位名称 |
| job_type | varchar(50) | | NULL | 职位类型 |
| base_location | varchar(100) | | NULL | 工作地点 |
| base_salary | decimal(10,2) | | NULL | 基本薪资 |
| edu_level | varchar(20) | | NULL | 教育要求 |
| experience | varchar(50) | | NULL | 经验要求 |
| describe | text | | NULL | 职位描述 |
| email | varchar(100) | | NULL | 联系邮箱 |

**索引设计**:
- 主键索引: `PRIMARY KEY (recruitment_id)`

**关联关系**:
- 一对多: recruitment → candidate (候选人)

#### 9. candidate - 候选人表
**业务含义**: 存储招聘候选人信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| candidate_id | int | 主键,自增 | auto_increment | 候选人ID |
| staff_id | varchar(20) | 外键(staff.staff_id) | NULL | 员工工号 |
| name | varchar(50) | 非空 | NULL | 候选人姓名 |
| job_name | varchar(100) | | NULL | 应聘职位 |
| edu_level | varchar(20) | | NULL | 教育水平 |
| major | varchar(100) | | NULL | 专业 |
| experience | varchar(50) | | NULL | 工作经验 |
| describe | text | | NULL | 个人描述 |
| email | varchar(100) | | NULL | 联系邮箱 |
| evaluation | text | | NULL | 评价 |
| status | varchar(20) | | NULL | 状态 |

**索引设计**:
- 主键索引: `PRIMARY KEY (candidate_id)`
- 外键索引: `fk_candidate_staff` (staff_id)

**关联关系**:
- 多对一: candidate → recruitment (招聘职位)
- 多对一: candidate → staff (员工信息)

#### 10. branch_company - 分公司表
**业务含义**: 管理分公司信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | int | 主键,自增 | auto_increment | 分公司ID |
| branch_id | varchar(20) | 非空,唯一 | NULL | 分公司编码 |
| name | varchar(100) | 非空 | NULL | 分公司名称 |
| desc | varchar(500) | | NULL | 分公司描述 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 唯一索引: `UNIQUE KEY (branch_id)`

#### 11. rank - 职级表
**业务含义**: 管理员工职级信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| rank_id | int | 主键,自增 | auto_increment | 职级ID |
| rank_name | varchar(50) | 非空 | NULL | 职级名称 |

**索引设计**:
- 主键索引: `PRIMARY KEY (rank_id)`

**关联关系**:
- 一对多: rank → staff (员工职级)

#### 12. notification - 通知公告表
**业务含义**: 存储系统通知和公告信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| notice_id | int | 主键,自增 | auto_increment | 通知ID |
| notice_title | varchar(200) | 非空 | NULL | 通知标题 |
| notice_content | text | 非空 | NULL | 通知内容 |
| type | varchar(50) | | NULL | 通知类型 |
| date | varchar(20) | | NULL | 发布日期 |

**索引设计**:
- 主键索引: `PRIMARY KEY (notice_id)`

#### 13. example - 考核评估表
**业务含义**: 管理考核评估项目

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| example_id | int | 主键,自增 | auto_increment | 考核ID |
| name | varchar(100) | 非空 | NULL | 考核名称 |
| describe | text | | NULL | 考核描述 |
| date | varchar(20) | | NULL | 考核日期 |
| limit | int | | NULL | 时间限制 |
| content | text | | NULL | 考核内容 |

**索引设计**:
- 主键索引: `PRIMARY KEY (example_id)`

**关联关系**:
- 一对多: example → example_score (考核成绩)

#### 14. example_score - 考核成绩表
**业务含义**: 记录员工的考核成绩

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| example_id | int | 主键,外键(example.example_id) | NULL | 考核ID |
| staff_id | varchar(20) | 主键,外键(staff.staff_id) | NULL | 员工工号 |
| staff_name | varchar(50) | 非空 | NULL | 员工姓名 |
| name | varchar(100) | 非空 | NULL | 考核名称 |
| date | varchar(20) | | NULL | 考核日期 |
| content | text | | NULL | 考核内容 |
| commit | text | | NULL | 提交内容 |
| score | decimal(5,2) | | NULL | 考核成绩 |

**索引设计**:
- 复合主键: `PRIMARY KEY (example_id, staff_id)`
- 外键索引: `fk_example_score_example` (example_id)
- 外键索引: `fk_example_score_staff` (staff_id)

**关联关系**:
- 多对一: example_score → example (考核项目)
- 多对一: example_score → staff (员工成绩)

## 数据关系图
```mermaid
erDiagram
    staff ||--o{ authority : "1:1"
    staff ||--o{ department : "n:1"
    staff ||--o{ rank : "n:1"
    staff ||--o{ salary : "1:1"
    staff ||--o{ attendance_record : "1:n"
    staff ||--o{ candidate : "1:n"
    staff ||--o{ example_score : "1:n"
    staff ||--o{ staff : "自关联(领导)"
    
    authority ||--o{ authority_detail : "1:n"
    
    salary ||--o{ salary_record : "1:n"
    
    recruitment ||--o{ candidate : "1:n"
    
    example ||--o{ example_score : "1:n"
    
    department ||--o{ staff : "1:n"
    rank ||--o{ staff : "1:n"
    
    staff {
        varchar staff_id PK
        varchar staff_name
        varchar leader_staff_id FK
        varchar leader_name
        date birthday
        varchar identity_num
        varchar sex
        varchar nation
        varchar school
        varchar major
        varchar edu_level
        decimal base_salary
        varchar card_num
        int rank_id FK
        int dep_id FK
        varchar email
        varchar phone
        date entry_date
    }
    
    authority {
        int authority_id PK
        varchar staff_id FK,UNIQUE
        varchar user_password
        varchar user_type
    }
    
    authority_detail {
        int id PK
        varchar user_type
        varchar model
        varchar authority_content
        varchar name
    }
    
    department {
        int dep_id PK
        varchar dep_name
        varchar dep_describe
    }
    
    salary {
        int salary_id PK
        varchar staff_id FK,UNIQUE
        varchar staff_name
        decimal base
        decimal subsidy
        decimal bonus
        decimal commission
        decimal fund
        decimal other
    }
    
    salary_record {
        int record_id PK
        varchar staff_id FK
        varchar staff_name
        decimal base
        decimal subsidy
        decimal bonus
        decimal commission
        decimal fund
        decimal other
        decimal endowment_insurance
        decimal medical_insurance
        decimal unemployment_insurance
        decimal housing_fund
        decimal tax
        decimal total
        varchar date
        varchar status
    }
    
    attendance_record {
        int attendance_id PK
        varchar staff_id FK
        varchar staff_name
        varchar date
        decimal work_days
        decimal leave_days
        decimal overtime_days
        varchar approve
    }
    
    recruitment {
        int recruitment_id PK
        varchar job_name
        varchar job_type
        varchar base_location
        decimal base_salary
        varchar edu_level
        varchar experience
        text describe
        varchar email
    }
    
    candidate {
        int candidate_id PK
        varchar staff_id FK
        varchar name
        varchar job_name
        varchar edu_level
        varchar major
        varchar experience
        text describe
        varchar email
        text evaluation
        varchar status
    }
    
    branch_company {
        int id PK
        varchar branch_id UNIQUE
        varchar name
        varchar desc
    }
    
    rank {
        int rank_id PK
        varchar rank_name
    }
    
    notification {
        int notice_id PK
        varchar notice_title
        text notice_content
        varchar type
        varchar date
    }
    
    example {
        int example_id PK
        varchar name
        text describe
        varchar date
        int limit
        text content
    }
    
    example_score {
        int example_id PK,FK
        varchar staff_id PK,FK
        varchar staff_name
        varchar name
        varchar date
        text content
        text commit
        decimal score
    }
```

## 性能优化分析
### 索引使用情况
1. **主键索引**: 所有表都有适当的主键索引
2. **外键索引**: 主要的外键关系都已建立索引
3. **唯一索引**: authority.staff_id, salary.staff_id, branch_company.branch_id
4. **复合索引**: example_score表的复合主键(example_id, staff_id)

### 查询性能优化
1. **员工信息查询**: 通过staff_id主键快速定位
2. **部门员工查询**: 通过dep_id外键索引优化
3. **薪资查询**: 通过staff_id唯一索引快速查找
4. **考勤记录查询**: 通过staff_id外键索引优化
5. **考核成绩查询**: 通过复合主键优化联合查询

## 数据安全和备份
### 敏感数据处理
1. **密码加密**: user_password字段应使用加密存储
2. **身份证号保护**: identity_num字段需要特殊保护
3. **银行卡号保护**: card_num字段需要加密存储
4. **薪资数据保护**: 所有薪资相关字段需要权限控制

### 备份恢复策略
1. **多数据库备份**: 每个分公司数据库独立备份
2. **定期备份**: 建议每日备份重要业务数据
3. **增量备份**: 对于大型表考虑增量备份策略
4. **灾难恢复**: 建立跨地域的数据备份机制

## 改进建议
### 数据库设计优化
1. **添加软删除**: 建议为主要业务表添加deleted_at字段实现软删除
2. **创建时间戳**: 建议为所有表添加created_at和updated_at字段
3. **数据分区**: 对于大型表(如attendance_record)考虑按时间分区
4. **归档策略**: 建立历史数据归档机制，提高查询性能

### 性能优化建议
1. **复合索引优化**: 为常用查询条件创建复合索引
2. **查询优化**: 避免全表扫描，优化复杂查询
3. **连接池配置**: 合理配置数据库连接池参数
4. **缓存策略**: 对高频访问数据实现缓存机制

### 安全性改进
1. **数据加密**: 对敏感字段实现端到端加密
2. **访问控制**: 实现更细粒度的数据访问控制
3. **审计日志**: 建立完整的数据操作审计日志
4. **权限分离**: 实现数据库级别的权限分离机制

## 多租户架构特点
1. **数据库隔离**: 每个分公司使用独立的数据库实例
2. **动态路由**: 通过Cookie中的branch_id实现数据库动态路由
3. **统一管理**: 通过GORM的DbMapper统一管理多个数据库连接
4. **扩展性**: 支持动态添加新的分公司数据库

## 技术栈总结
- **ORM框架**: GORM v1.9.16
- **数据库**: SQLite(开发环境) / MySQL(生产环境)
- **连接管理**: 连接池模式，支持多数据库
- **字符集**: utf8mb4
- **存储引擎**: InnoDB
- **编程语言**: Go
- **Web框架**: Gin